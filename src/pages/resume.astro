---
import BaseLayout from "../layouts/BaseLayout.astro";
import { drafts, defaultDraftId } from "../data/resumeDrafts";

function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return date.toLocaleDateString("en-US", {
        month: "short",
        year: "numeric",
    });
}

// Use the default draft for page metadata
const defaultDraft = drafts.find((d) => d.id === defaultDraftId)!;
const { basics } = defaultDraft.data;
const defaultName = basics.name.toLowerCase().replace(/[^a-z0-9]/g, "-");
const defaultPdfUrl = `/${defaultName}-resume-${defaultDraft.id}.pdf`;
---

<BaseLayout title={`Resume — ${basics.name}`} description={basics.label}>
    <div class="resume-page">
        <!-- Header / Download -->
        <div class="resume-header">
            <div>
                <h1>{basics.name}</h1>
                <p class="resume-label" id="resume-label">{basics.label}</p>
                <p class="resume-location">
                    <svg
                        viewBox="0 0 24 24"
                        width="16"
                        height="16"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"
                        ></path><circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    {basics.location.city}, {basics.location.region}
                    <span style="margin: 0 var(--space-2);">•</span>
                    <a
                        href={`mailto:${basics.email}`}
                        class="profile-link"
                        style="color: inherit; text-decoration: none;"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            width="16"
                            height="16"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path
                                d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                            ></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        {basics.email}
                    </a>
                </p>
                <div class="resume-profiles">
                    {
                        basics.profiles.map((profile) => (
                            <a
                                href={profile.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="profile-link"
                                title={
                                    profile.network === "html5"
                                        ? "Website"
                                        : profile.network
                                }
                            >
                                {profile.network === "LinkedIn" && (
                                    <svg
                                        viewBox="0 0 24 24"
                                        width="16"
                                        height="16"
                                        fill="currentColor"
                                    >
                                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                                    </svg>
                                )}
                                {profile.network === "GitHub" && (
                                    <svg
                                        viewBox="0 0 24 24"
                                        width="16"
                                        height="16"
                                        fill="currentColor"
                                    >
                                        <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
                                    </svg>
                                )}
                                {profile.network === "html5" && (
                                    <svg
                                        viewBox="0 0 24 24"
                                        width="16"
                                        height="16"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <circle cx="12" cy="12" r="10" />
                                        <line x1="2" y1="12" x2="22" y2="12" />
                                        <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z" />
                                    </svg>
                                )}
                                {profile.network === "html5"
                                    ? profile.username
                                    : profile.network}
                            </a>
                        ))
                    }
                </div>
            </div>
            <a
                href={defaultPdfUrl}
                download
                class="btn btn-primary"
                id="download-pdf-btn"
            >
                <svg
                    viewBox="0 0 24 24"
                    width="16"
                    height="16"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download PDF
            </a>
        </div>

        <!-- Draft Selector -->
        <div
            class="draft-selector"
            role="tablist"
            aria-label="Resume focus area"
        >
            {
                drafts.map((draft) => {
                    const name = draft.data.basics.name
                        .toLowerCase()
                        .replace(/[^a-z0-9]/g, "-");
                    const pdfUrl = `/resumes/${name}-resume-${draft.id}.pdf`;
                    return (
                        <button
                            class={`draft-btn ${
                                draft.id === defaultDraftId ? "active" : ""
                            }`}
                            data-draft-id={draft.id}
                            data-pdf-url={pdfUrl}
                            role="tab"
                            aria-selected={
                                draft.id === defaultDraftId ? "true" : "false"
                            }
                            aria-controls={`draft-${draft.id}`}
                        >
                            {draft.label}
                        </button>
                    );
                })
            }
        </div>

        <!-- Draft Content Panels -->
        {
            drafts.map((draft) => {
                const {
                    basics: db,
                    work,
                    education,
                    skills,
                    awards,
                    volunteer,
                    references,
                } = draft.data as any;
                const isDefault = draft.id === defaultDraftId;
                return (
                    <div
                        class={`draft-panel ${isDefault ? "active" : ""}`}
                        id={`draft-${draft.id}`}
                        data-draft-panel={draft.id}
                        data-label={db.label}
                        role="tabpanel"
                        aria-hidden={isDefault ? "false" : "true"}
                    >
                        {/* Summary */}
                        <section class="resume-section">
                            <h2 class="resume-section-title">Summary</h2>
                            <p class="resume-summary">{db.summary}</p>
                        </section>

                        {/* Experience */}
                        <section class="resume-section">
                            <h2 class="resume-section-title">Experience</h2>
                            <div class="timeline">
                                {work.map((job: any) => (
                                    <div class="timeline-item">
                                        <div class="timeline-header">
                                            <div>
                                                <h3 class="timeline-title">
                                                    {job.position}
                                                </h3>
                                                <p class="timeline-org">
                                                    {job.name} · {job.location}
                                                </p>
                                            </div>
                                            <span class="timeline-date">
                                                {formatDate(job.startDate)} —{" "}
                                                {job.endDate
                                                    ? formatDate(job.endDate)
                                                    : "Present"}
                                            </span>
                                        </div>
                                        {job.highlights && (
                                            <ul class="timeline-highlights">
                                                {job.highlights.map(
                                                    (h: any) => (
                                                        <li
                                                            set:html={h.replace(
                                                                /\*\*(.*?)\*\*/g,
                                                                "<strong>$1</strong>"
                                                            )}
                                                        />
                                                    )
                                                )}
                                            </ul>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* Education */}
                        <section class="resume-section">
                            <h2 class="resume-section-title">Education</h2>
                            {education.map((edu: any) => (
                                <div class="timeline-item">
                                    <div class="timeline-header">
                                        <div>
                                            <h3 class="timeline-title">
                                                {edu.institution}
                                            </h3>
                                            <p class="timeline-org">
                                                {edu.studyType} in {edu.area}
                                            </p>
                                            {edu.gpa && (
                                                <p class="timeline-detail">
                                                    GPA: {edu.gpa}
                                                </p>
                                            )}
                                            {edu.summary && (
                                                <p class="timeline-detail">
                                                    {edu.summary}
                                                </p>
                                            )}
                                        </div>
                                        <span class="timeline-date">
                                            {formatDate(edu.startDate)} —{" "}
                                            {formatDate(edu.endDate)}
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </section>

                        {/* Skills */}
                        <section class="resume-section">
                            <h2 class="resume-section-title">Skills</h2>
                            <div class="skills-grid">
                                {skills.map((group: any) => (
                                    <div class="skill-group">
                                        <h4 class="skill-group-name">
                                            {group.name}
                                        </h4>
                                        <div class="tag-list">
                                            {group.keywords.map((kw: any) => (
                                                <span class="tag">{kw}</span>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* Awards */}
                        {awards && awards.length > 0 && (
                            <section class="resume-section">
                                <h2 class="resume-section-title">Awards</h2>
                                {awards.map((award: any) => (
                                    <div class="award-item">
                                        <div class="timeline-header">
                                            <div>
                                                <h3 class="timeline-title">
                                                    {award.title}
                                                </h3>
                                                <p class="timeline-org">
                                                    {award.awarder}
                                                </p>
                                                {award.summary && (
                                                    <p class="timeline-detail">
                                                        {award.summary}
                                                    </p>
                                                )}
                                            </div>
                                            {award.date && (
                                                <span class="timeline-date">
                                                    {formatDate(award.date)}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </section>
                        )}

                        {/* Volunteer */}
                        {volunteer && volunteer.length > 0 && (
                            <section class="resume-section">
                                <h2 class="resume-section-title">
                                    Volunteer & Community
                                </h2>
                                <div class="timeline">
                                    {volunteer.map((vol: any) => (
                                        <div class="timeline-item">
                                            <div class="timeline-header">
                                                <div>
                                                    <h3 class="timeline-title">
                                                        {vol.position}
                                                    </h3>
                                                    <p class="timeline-org">
                                                        {vol.organization}
                                                    </p>
                                                </div>
                                                {vol.startDate && (
                                                    <span class="timeline-date">
                                                        {formatDate(
                                                            vol.startDate
                                                        )}{" "}
                                                        —{" "}
                                                        {vol.endDate
                                                            ? formatDate(
                                                                  vol.endDate
                                                              )
                                                            : "Present"}
                                                    </span>
                                                )}
                                            </div>
                                            {vol.summary && (
                                                <p class="vol-summary">
                                                    {vol.summary}
                                                </p>
                                            )}
                                            {vol.highlights && (
                                                <ul class="timeline-highlights">
                                                    {vol.highlights.map(
                                                        (h: any) => (
                                                            <li
                                                                set:html={h.replace(
                                                                    /\*\*(.*?)\*\*/g,
                                                                    "<strong>$1</strong>"
                                                                )}
                                                            />
                                                        )
                                                    )}
                                                </ul>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}

                        {/* References */}
                        {references && references.length > 0 && (
                            <section class="resume-section">
                                <h2 class="resume-section-title">References</h2>
                                <div class="references-grid">
                                    {references.map((ref: any) => (
                                        <div class="reference-card">
                                            <blockquote class="reference-quote">
                                                <p>"{ref.reference}"</p>
                                            </blockquote>
                                            <p class="reference-name">
                                                {ref.name}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}
                    </div>
                );
            })
        }
    </div>
</BaseLayout>

<script>
    function initDraftSelector() {
        const buttons =
            document.querySelectorAll<HTMLButtonElement>(".draft-btn");
        const panels = document.querySelectorAll<HTMLElement>(".draft-panel");
        const label = document.getElementById("resume-label");
        const downloadBtn = document.getElementById(
            "download-pdf-btn"
        ) as HTMLAnchorElement;

        buttons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const draftId = btn.dataset.draftId;
                if (!draftId) return;

                // Update button states
                buttons.forEach((b) => {
                    b.classList.remove("active");
                    b.setAttribute("aria-selected", "false");
                });
                btn.classList.add("active");
                btn.setAttribute("aria-selected", "true");

                // Update download link
                if (downloadBtn && btn.dataset.pdfUrl) {
                    downloadBtn.href = btn.dataset.pdfUrl;
                }

                // Swap panels with fade
                panels.forEach((panel) => {
                    if (panel.dataset.draftPanel === draftId) {
                        panel.classList.add("active");
                        panel.setAttribute("aria-hidden", "false");
                        // Update the label in the header
                        if (label && panel.dataset.label) {
                            label.textContent = panel.dataset.label;
                        }
                    } else {
                        panel.classList.remove("active");
                        panel.setAttribute("aria-hidden", "true");
                    }
                });
            });
        });
    }

    // Run on initial load and on Astro page transitions
    initDraftSelector();
    document.addEventListener("astro:after-swap", initDraftSelector);
</script>

<style>
    .resume-page {
        max-width: 860px;
        margin: 0 auto;
    }

    /* Header */
    .resume-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--space-6);
        padding-bottom: var(--space-8);
        border-bottom: 1px solid var(--color-border);
        margin-bottom: var(--space-6);
    }

    /* Profile Links */
    .resume-profiles {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-4);
        margin-top: var(--space-3);
    }

    .profile-link {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        text-decoration: none;
        transition: color var(--transition-fast);
    }

    .profile-link:hover {
        color: var(--color-accent);
    }

    .profile-link svg {
        flex-shrink: 0;
    }

    .resume-header h1 {
        margin-bottom: var(--space-2);
    }

    .resume-label {
        font-size: var(--text-lg);
        color: var(--color-text-secondary);
        margin: 0 0 var(--space-2);
        transition: opacity var(--transition-fast);
    }

    .resume-location {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin: 0;
    }

    /* Draft Selector */
    .draft-selector {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        padding: var(--space-4) 0;
        margin-bottom: var(--space-8);
        border-bottom: 1px solid var(--color-border);
    }

    .draft-btn {
        display: inline-flex;
        align-items: center;
        padding: var(--space-2) var(--space-5);
        font-size: var(--text-sm);
        font-weight: 500;
        font-family: var(--font-sans);
        color: var(--color-text-secondary);
        background: var(--color-bg-alt);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-full);
        cursor: pointer;
        transition: all var(--transition-fast);
        white-space: nowrap;
    }

    .draft-btn:hover {
        color: var(--color-accent);
        border-color: var(--color-accent-subtle);
        background: var(--color-accent-light);
    }

    .draft-btn.active {
        color: var(--color-text-inverse);
        background: var(--color-accent);
        border-color: var(--color-accent);
    }

    .draft-btn.active:hover {
        background: var(--color-accent-hover);
        border-color: var(--color-accent-hover);
        color: var(--color-text-inverse);
    }

    /* Draft Panels */
    .draft-panel {
        display: none;
        animation: fadeIn var(--transition-slow) ease;
    }

    .draft-panel.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Section */
    .resume-section {
        margin-bottom: var(--space-12);
    }

    .resume-section-title {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--color-text);
        padding-bottom: var(--space-3);
        border-bottom: 2px solid var(--color-accent);
        margin-bottom: var(--space-6);
        display: inline-block;
    }

    .resume-summary {
        font-size: var(--text-base);
        line-height: 1.8;
        color: var(--color-text-secondary);
    }

    /* Timeline */
    .timeline {
        display: flex;
        flex-direction: column;
        gap: var(--space-8);
    }

    .timeline-item {
        padding-left: var(--space-6);
        border-left: 2px solid var(--color-border);
        position: relative;
    }

    .timeline-item::before {
        content: "";
        position: absolute;
        left: -5px;
        top: 6px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--color-accent);
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--space-4);
        margin-bottom: var(--space-3);
    }

    .timeline-title {
        font-size: var(--text-lg);
        font-weight: 600;
        margin: 0;
    }

    .timeline-org {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        margin: var(--space-1) 0 0;
    }

    .timeline-detail {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin: var(--space-1) 0 0;
        font-style: italic;
    }

    .timeline-date {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        white-space: nowrap;
        flex-shrink: 0;
    }

    .timeline-highlights {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .timeline-highlights li {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        padding: var(--space-1) 0;
        padding-left: var(--space-5);
        position: relative;
        line-height: 1.6;
    }

    .timeline-highlights li::before {
        content: "›";
        position: absolute;
        left: 0;
        color: var(--color-accent);
        font-weight: 700;
        font-size: var(--text-base);
    }

    .vol-summary {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        margin: 0 0 var(--space-3);
        line-height: 1.6;
    }

    /* Skills */
    .skills-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--space-6);
    }

    .skill-group {
        padding: var(--space-5);
        background: var(--color-bg-alt);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
    }

    .skill-group-name {
        font-size: var(--text-sm);
        font-weight: 600;
        margin: 0 0 var(--space-3);
        color: var(--color-text);
    }

    /* Award */
    .award-item {
        padding: var(--space-5);
        background: var(--color-bg-alt);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
    }

    /* References */
    .references-grid {
        display: flex;
        flex-direction: column;
        gap: var(--space-6);
    }

    .reference-card {
        padding: var(--space-6);
        background: var(--color-bg-alt);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
    }

    .reference-quote {
        border-left: 3px solid var(--color-accent);
        padding: 0 0 0 var(--space-5);
        margin: 0 0 var(--space-4);
        font-style: italic;
    }

    .reference-quote p {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        line-height: 1.7;
        margin: 0;
    }

    .reference-name {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--color-text);
        margin: 0;
    }

    @media (max-width: 768px) {
        .resume-header {
            flex-direction: column;
        }

        .timeline-header {
            flex-direction: column;
            gap: var(--space-1);
        }

        .skills-grid {
            grid-template-columns: 1fr;
        }

        .draft-selector {
            gap: var(--space-2);
        }

        .draft-btn {
            font-size: var(--text-xs);
            padding: var(--space-2) var(--space-3);
        }
    }
</style>
